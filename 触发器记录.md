# 查询 TRIGGERS
SHOW TRIGGERS WHERE `Table` = 'gameRecord';

# 删除 TRIGGERS
DROP TRIGGER IF EXISTS update_valid_bet_amount;
DROP TRIGGER IF EXISTS Trigger名字;


1. 插入时根据 gameVendor 自动设置 countValidBetWay
  •	根据 gameVendor 字段来自动设置 countValidBetWay 字段
   - 当插入或更新 gameRecord 表时，根据 gameVendor 字段来自动设置 countValidBetWay 字段：
	•	如果 gameVendor = 'Spribe' → countValidBetWay = 'byWinLose'
	•	其他厂商 → countValidBetWay = 'byBet'
  - 插入countValidBetWay
DELIMITER $$

CREATE TRIGGER set_valid_bet_way_by_vendor_on_insert
BEFORE INSERT ON gameRecord
FOR EACH ROW
BEGIN
  IF NEW.gameVendor = 'Spribe' THEN
    SET NEW.countValidBetWay = 'byWinLose';
  ELSE
    SET NEW.countValidBetWay = 'byBet';
  END IF;
END$$

DELIMITER ;
- 更新时根据 gameVendor 自动更新 countValidBetWay
    •	当更新
DELIMITER $$

CREATE TRIGGER set_valid_bet_way_by_vendor
BEFORE UPDATE ON gameRecord
FOR EACH ROW
BEGIN
  IF NEW.gameVendor = 'Spribe' THEN
    SET NEW.countValidBetWay = 'byWinLose';
  ELSE
    SET NEW.countValidBetWay = 'byBet';
  END IF;
END$$

DELIMITER ;

2. 插入时根据策略自动计算 validBetAmount
    - 更新或插入 betAmount 或 gameResult 或 countValidBetWay 时，自动同步更新 validBetAmount 字段，规则如下：
	•	如果 countValidBetWay = 'byBet'，则 validBetAmount = betAmount
	•	如果 countValidBetWay = 'byWinLose'，则 validBetAmount = ABS(gameResult)

- 当插入
DELIMITER $$

CREATE TRIGGER set_valid_bet_amount_on_update
BEFORE INSERT ON gameRecord
FOR EACH ROW
BEGIN
  IF NEW.countValidBetWay = 'byBet' THEN
    SET NEW.validBetAmount = NEW.betAmount;
  ELSEIF NEW.countValidBetWay = 'byWinLose' THEN
    SET NEW.validBetAmount = ABS(NEW.gameResult);
  ELSE
    SET NEW.validBetAmount = 0;
  END IF;
END$$

DELIMITER ;


- 更新 betAmount 或 gameResult 或 countValidBetWay 时，自动同步更新 validBetAmount 字段，规则如下：
	•	如果 countValidBetWay = 'byBet'，则 validBetAmount = betAmount
	•	如果 countValidBetWay = 'byWinLose'，则 validBetAmount = ABS(gameResult)
DELIMITER $$

CREATE TRIGGER set_valid_bet_amount_on_update
BEFORE UPDATE ON gameRecord
FOR EACH ROW
BEGIN
  IF NEW.countValidBetWay = 'byBet' THEN
    SET NEW.validBetAmount = NEW.betAmount;
  ELSEIF NEW.countValidBetWay = 'byWinLose' THEN
    SET NEW.validBetAmount = ABS(NEW.gameResult);
  ELSE
    SET NEW.validBetAmount = 0; -- 可选兜底逻辑
  END IF;
END$$

DELIMITER ;

3. 触发器会 自动补合法组合，这样即使 gameVendor 和 gameType 都没传，也不会被之前的合法性触发器拒绝。
   - CREATE TRIGGER auto_fill_gameVendor_gameType_update
     BEFORE UPDATE ON gameRecord

DELIMITER $$

CREATE TRIGGER auto_fill_gameVendor_gameType_insert
BEFORE INSERT ON gameRecord
FOR EACH ROW
BEGIN
  -- 如果 gameVendor 或 gameType 为空，随机合法组合
  IF NEW.gameVendor IS NULL OR NEW.gameVendor = ''
     OR NEW.gameType IS NULL OR NEW.gameType = '' THEN

    -- 生成一个随机合法组合
    SET @rand := FLOOR(1 + RAND() * 13); -- 总共 13 个合法组合（按你之前列的）

    CASE @rand
      WHEN 1 THEN SET NEW.gameVendor = 'PG';       SET NEW.gameType = 'slot';
      WHEN 2 THEN SET NEW.gameVendor = 'Spribe';   SET NEW.gameType = 'slot';
      WHEN 3 THEN SET NEW.gameVendor = 'Evolution';SET NEW.gameType = 'casino';
      WHEN 4 THEN SET NEW.gameVendor = 'Tada';     SET NEW.gameType = 'slot';
      WHEN 5 THEN SET NEW.gameVendor = 'Tada';     SET NEW.gameType = 'fishing';
      WHEN 6 THEN SET NEW.gameVendor = 'Tada';     SET NEW.gameType = 'card';
      WHEN 7 THEN SET NEW.gameVendor = 'FaChai';   SET NEW.gameType = 'slot';
      WHEN 8 THEN SET NEW.gameVendor = 'POPOK';    SET NEW.gameType = 'slot';
      WHEN 9 THEN SET NEW.gameVendor = 'G759';     SET NEW.gameType = 'slot';
      WHEN 10 THEN SET NEW.gameVendor = 'CP';      SET NEW.gameType = 'slot';
      WHEN 11 THEN SET NEW.gameVendor = 'JBD';     SET NEW.gameType = 'slot';
      WHEN 12 THEN SET NEW.gameVendor = 'Evoplay'; SET NEW.gameType = 'slot';
      WHEN 13 THEN SET NEW.gameVendor = 'CQ9';     SET NEW.gameType = 'slot';
    END CASE;

  END IF;
END $$

DELIMITER ;

1. 插入或更新数据时gameType未传，就根据 NEW.gameVendor，从允许的类型里随机挑一个gameType填入。
DELIMITER $$

CREATE TRIGGER auto_fill_gameType_insert
BEFORE INSERT ON gameRecord
FOR EACH ROW
BEGIN
  IF NEW.gameType IS NULL OR NEW.gameType = '' THEN
    CASE NEW.gameVendor
      WHEN 'PP' THEN SET NEW.gameType = 'slot';
      WHEN 'FaChai' THEN SET NEW.gameType = 'slot';
      WHEN 'POPOK' THEN SET NEW.gameType = 'slot';
      WHEN 'G759' THEN SET NEW.gameType = 'slot';
      WHEN 'CP' THEN SET NEW.gameType = 'slot';
      WHEN 'Spribe' THEN SET NEW.gameType = 'slot';
      WHEN 'JBD' THEN SET NEW.gameType = 'slot';
      WHEN 'Evoplay' THEN SET NEW.gameType = 'slot';
      WHEN 'CQ9' THEN SET NEW.gameType = 'slot';
      WHEN 'PG' THEN SET NEW.gameType = 'slot';
      WHEN 'Evolution' THEN SET NEW.gameType = 'casino';
      WHEN 'Tada' THEN
        -- slot、fishing、card 中随机一个
        SET NEW.gameType = ELT(FLOOR(1 + RAND() * 3), 'slot', 'fishing', 'card');
    END CASE;
  END IF;
END$$

DELIMITER ;

